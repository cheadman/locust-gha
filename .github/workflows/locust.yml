name: Load Testing with Locust

on:
  workflow_dispatch:
    inputs:
      endpoint:
        description: 'Endpoint URL'
        required: true
        default: ''
      test_file:
        description: 'Name of the test file in the locust directory to run.'
        required: true
        default: 'load.py'
      users:
        description: 'Number of Users'
        required: false
        default: '1'
      spawn_rate:
        description: 'Spawn Rate'
        required: false
        default: '1'
      test_duration:
        description: 'Load test duration in minutes'
        required: false
        default: '1'
      min_wait:
        description: 'The min time between requests for a user'
        required: false
        default: '1'
      max_wait:
        description: 'The max time between requests for a user'
        required: false
        default: '3'
      headers:
        description: 'The http headers to include in the request'
        required: false
        default: '{"HeaderName1": "HeaderValue1", "HeaderName2": "HeaderValue2"}'
  push:
    branches:
      - locust

jobs:
  load_test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          pip install locust
      
      - name: Run Locust load test
        env:
          ENDPOINT: ${{ github.event.inputs.endpoint }}
          USERS: ${{ github.event.inputs.users }}
          SPAWN_RATE: ${{ github.event.inputs.spawn_rate }}
          TEST_DURATION: ${{ github.event.inputs.test_duration }}
          LOCUST_MIN_WAIT: ${{ github.event.inputs.min_wait }}
          LOCUST_MAX_WAIT: ${{ github.event.inputs.max_wait }}
          TEST_FILE: ${{ github.event.inputs.test_file }}
          LOCUST_HEADERS: ${{ github.event.inputs.headers }}
        run: |
          mkdir reports          
          locust --host=$ENDPOINT -f locust/load.py --users $USERS --spawn-rate $SPAWN_RATE --run-time ${TEST_DURATION}m --csv=reports/report.csv --html=reports/report.html --headless
      
      - name: Upload reports
        uses: actions/upload-artifact@v2
        with:
          name: Load_Test_Reports
          path: reports
